---
title: "Final Project"
format: pdf
date: "2025-05-14"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(KMsurv)
library(survival)
library(survminer)
data(burn)
```

# 1 Introduction

In this analysis, we examine the **burn** dataset from the `KMsurv` package, which contains clinical records of 154 burn patients including time to staphylococcus aureus infection and censoring indicators.  

We define the failure time as `T3` (days until Staphylococcus aureus infection or censoring) and the event indicator `D3` (1 = infection, 0 = censored). Covariates include:

- **Z1**: Treatment type (0 = routine bathing, 1 = body cleansing)
- **Z2**: Gender (0 = male, 1 = female)
- **Z3**: Race (0 = nonwhite, 1 = white)
- **Z4**: Percent total surface area burned
- **Z5-Z10**: Indicators for burn site in head, buttock, trunk, upper leg, lower leg, respiratory tract (0/1)
- **Z11**: Burn type (1 = chemical, 2 = scald, 3 = electric, 4 = flame)

The main scientific question motivating this study is: 
*How does the cleansing treatment affect the hazard of Staphylococcus aureus infection, accounting for patient and burn characteristics?*
\newpage

# 2 Model Fitting

We start with univariate Kaplan-Meier estimation and then fit multivariable Cox proportional hazards models, using AIC for forward stepwise selection to identify the most influential covariates.

## 2.1 Kaplan-Meier Estimate

```{r KM Estimate, fig.cap = "Kaplan-Meier Survival Curve Estimate of Time (Days) to Staphylococcus Aureus Infection"}
burn.surv <- Surv(time = burn$T3, event = burn$D3)
ggsurvplot(
  survfit(burn.surv ~ 1),
  surv.median.line = "hv",
  data = burn,
  xlab = "Time (Days)",
  ylab = "Survival Probability",
  title = "KM Estimate of Time to Staphylococcus Aureus Infection"
)
```
The KM curve estimates the survival probability for time to Staphylocococcus aureus infection across all patients.  The median survival time, where the probability drops to 50%, is approximately 51 days.  This provides a baseline understanding of infetion risk before adjusting for covariates.

## 2.2 Cox Proportional Hazards Model

### 2.2.1 Full Model

```{r}
cox_full <- coxph(burn.surv ~ Z1 + Z2 + Z3 + Z4 + Z5 + 
                    Z6 + Z7 + Z8 + Z9 + Z10 + as.factor(Z11), data = burn)
summary(cox_full)
```
The full Cox model assessed factors influencing time to Staphylococcus aureus infection in burn patients. Key results include:

Treatment (Z1): Hazard ratio (HR) = 0.521 (95% CI: 0.276–0.982, p = 0.044). Body cleansing reduces infection risk by 47.9% compared to routine bathing, a significant finding.

Race (Z3): HR = 8.577 (95% CI: 1.117–65.875, p = 0.039). White patients have a higher infection risk than nonwhite patients, warranting further study.

Burn Type (Z11): Electric burns (Z11=3) show a marginally significant higher risk (HR = 8.957, p = 0.052) vs chemical burns.

Other factors (e.g., gender, burn extent, burn sites) were not significant. Model fit is good (concordance = 0.739), with significant overall tests (p ≤ 0.05). Body cleansing appears protective, while race differences need exploration.

### 2.2.2 Stepwise Selection by AIC

```{r}
cox_step <- step(coxph(burn.surv ~ 1, data = burn), 
                 scope = ~ Z1 + Z2 + Z3 + Z4 + Z5 + 
                   Z6 + Z7 + Z8 + Z9 + Z10 + as.factor(Z11), 
                 direction = "forward", k = 2)
summary(cox_step)
```
The retention of Z3 (Race), Z11 (Burn Type), Z1 (Treatment Type), and Z2 (Gender) in the stepwise selection process highlights their combined importance in predicting infection risk, even if only Z1 and Z3 are individually significant. The consistent significance of body cleansing (Z1) reinforces its protective effect, while race (Z3) emerges as a key risk factor. The marginal significance of electric burns (Z11=3) and the potential violations of the proportional hazards assumption for Z9 and Z10 suggest areas for further investigation, possibly through stratified models or time-varying effects. Overall, the model provides a robust framework for understanding infection risk in burn patients, with a good fit and reliable predictors.
\newpage

# 3 Checking Proportional Hazards Assumptions

In this section, we will be using techniques (log-log plots, Cox ZPH test, and Schoenfield Residuals) to check whether the proportional hazards (PH) assumption is being met by the covariates that are important in the model.

## 3.1 Log-log Plots

First, we will visualize the log-log plots for each covariate in the model:

```{r Log-log plot (Z1), fig.cap = "Log(-log) Survival Curves by Treatment Type (Z1) to Evaluate PH Assumption"}
# Log-log plot for Z1 (Treatment Type)
burn.fit1 <- survfit(burn.surv ~ Z1, data = burn)
ggsurvplot(burn.fit1,
           legend.labs = c("Routine Bathing", "Body Cleansing"),
           fun = "cloglog") +
  labs(title = "Log(-log) of Survival Curve by Treatment (Z1)",
       x = "Time (Days) to straphylocous aureaus infection")
```

The curves for the two treatment groups appear generally parallel over time. This suggest that the PH assumption is reasonable for treatment type (`Z1`).

```{r Log-log plot (Z2), fig.cap = "Log(-log) Survival Curves by Gender (Z2) to Evaluate PH Assumption"}
# Log-log plot for Z2 (gender)
burn.fit2 <- survfit(burn.surv ~ Z2, data = burn)
ggsurvplot(burn.fit2,
           legend.labs = c("Male", "Female"),
           fun = "cloglog") +
  labs(title = "Log(-log) of Survival Curve by Gender (Z2)",
       x = "Time (Days) to straphylocous aureaus infection")
```

Although the curves for the male and female groups show some divergence at the beginning and end time points, in the middle they look reasonably parallel. Therefore, this suggests that the PH assumption is reasonable for gender (`Z2`).

```{r Log-log plot (Z3), fig.cap = "Log(-log) Survival Curves by Race (Z3) to Evaluate PH Assumption"}
# Log-log plot for Z3 (race)
burn.fit3 <- survfit(burn.surv ~ Z3, data = burn)
ggsurvplot(burn.fit3,
           legend.labs = c("Nonwhite", "White"),
           fun = "cloglog") +
  labs(title = "Log(-log) Survival Curve by Race (Z3)",
       x = "Time (Days) to straphylocous aureaus infection")
```

It is clear that the two curves are clearly not parallel, and show significant divergence over time. Therefore, this suggests a potential violation of the PH assumption for race (`Z3`).

```{r Log-log plot (Z11), fig.cap = "Log(-log) Survival Curves by Burn Type (Z11) to Evaluate PH Assumption"}
# Log-log plot for Z11 (burn type)
burn.fit4 <- survfit(burn.surv ~ as.factor(Z11), data = burn)
ggsurvplot(burn.fit4,
           legend.labs = c("Chemical", "Scald", "Electric", "Flame"),
           fun = "cloglog") +
  labs(title = "Log(-log) of Survival Curve by Burn Type (Z11)",
       x = "Time (Days) to straphylocous aureaus infection")
```

We can see that the four curves are not parallel. This can be seen by the curves `Scald` and `Flame` curve crossing, as well as the divergence of all the curves over time. Therefore, this suggests a potential violation of the PH assumption for burn type (`Z11`).

In summary, the log-log plots demonstrated that two of the covariates potentially violated a PH assumption, race (`Z3`) and burn type (`Z11`). While the other two covariates, treatment type (`Z1`) and gender (`Z2`), reasonably satisfy the PH assumption.

## 3.2 Cox ZPH Test

Now, we will run the Cox ZPH test for correlation in the residuals for our covariates in the model. Although this test is more useful for continuous covariates, it is still useful for categorical covariates as well. 

```{r Cox ZPH Test}
# Cox ZPH test for correlation in the residuals
zph_test <- cox.zph(cox_step)
print(zph_test) # displays results
```

The Cox ZPH test results show us that:

- `Z1` produced a p-value of 0.501. This p-value is greater than 0.05, indicating that we fail to reject the null hypothesis. Therefore, this suggests the PH assumption is reasonable for treatment type (`Z1`). 

- `Z2` produced a p-value of 0.209. This p-value is greater than 0.05, indicating that we fail to reject the null hypothesis. Therefore, this suggests the PH assumption is reasonable for gender (`Z2`).

- `Z3` produced a p-value of 0.119. This p-value is greater than 0.05, indicating that we fail to reject the null hypothesis. Therefore, this suggests the PH assumption is reasonable for race (`Z3`).

- `Z11` produced a p-value of 0.038. This p-value is less than 0.05, indicating that we fail to reject the null hypothesis. Therefore, this suggests the PH assumption is not reasonable for burn type (`Z11`).

## 3.3 Schoenfield Residual Plots

```{r Schoenfield Plots}
plot(zph_test)
```

Z1 (Treatment Type): The residuals for Z1 show no clear trend or systematic pattern over time, with points scattered around zero. This aligns with the Cox ZPH test (p = 0.501) and log-log plot, confirming that the PH assumption is reasonable for treatment type.

Z2 (Gender): The residuals for Z2 appear relatively flat with minor fluctuations, consistent with the Cox ZPH test (p = 0.209) and the log-log plot, which showed reasonable parallelism. This suggests the PH assumption holds for gender.

Z3 (Race): The residuals for Z3 exhibit a slight trend, with some indication of non-random variation over time. Although the Cox ZPH test (p = 0.119) did not reject the PH assumption at the 0.05 level, the log-log plot showed clear divergence, suggesting a potential violation. This warrants further investigation, possibly with a time-varying model.

Z11 (Burn Type): The residuals for burn type levels (Z11=2, 3, 4) show more pronounced patterns. For electric burns (Z11=3), the residuals suggest a time-varying effect, with a noticeable trend over time, consistent with the Cox ZPH test (p = 0.038 for Z11). The log-log plot also showed non-parallel curves, particularly for scald and flame burns, confirming a violation of the PH assumption for burn type.


# 4 Conclusions

This study investigated the effect of body cleansing treatment (Z1) on the hazard of Staphylococcus aureus infection in burn patients, accounting for patient and burn characteristics. The final Cox proportional hazards model, selected via forward stepwise AIC, included treatment type (Z1), race (Z3), burn type (Z11), and gender (Z2) as predictors of time to infection.

The primary finding addresses the scientific question: body cleansing (Z1 = 1) significantly reduces the hazard of Staphylococcus aureus infection compared to routine bathing (Z1 = 0), with a hazard ratio (HR) of 0.523 (95% CI: 0.291–0.940, p = 0.030). This indicates that body cleansing decreases the infection risk by approximately 47.7%, a statistically significant protective effect. This finding suggests that body cleansing should be considered a preferred treatment for burn patients to reduce infection risk.

Additionally, race (Z3) was a significant predictor, with white patients (Z3 = 1) having a substantially higher infection risk than nonwhite patients (HR = 9.850, 95% CI: 1.318–73.643, p = 0.026). This unexpected result requires further investigation to understand potential biological or environmental factors driving this difference. Burn type (Z11) showed a marginally significant effect for electric burns (Z11 = 3) compared to chemical burns (HR = 7.901, 95% CI: 0.935–66.808, p = 0.058), suggesting a higher infection risk, though the wide confidence interval indicates uncertainty. Gender (Z2) was not significant (HR = 0.571, 95% CI: 0.263–1.242, p = 0.158), suggesting no strong evidence of a gender effect on infection risk.

The model fit was robust, with a concordance of 0.719 (SE = 0.037) and significant overall tests (Likelihood ratio test: p = 0.0005; Wald test: p = 0.004; Score test: p = 0.001). However, the proportional hazards assumption was violated for burn type (Z11, Cox ZPH p = 0.038) and potentially for race (Z3, based on log-log plots), indicating that the effects of these covariates may vary over time.

In conclusion, body cleansing is an effective intervention for reducing Staphylococcus aureus infection risk in burn patients. The significant effect of race and the marginal effect of electric burns highlight the need for further research into these factors, particularly considering time-varying effects to account for PH violations.

# 5 Time-Varying Treatment Effect


```{r}
cox_tvc <- coxph(burn.surv ~ Z1 + Z2 + Z3 + as.factor(Z11) + tt(as.factor(Z11)),
                 data = burn,
                 tt = function(x, t, ...) {
                   x1 <- (x == 2) * log(t)
                   x2 <- (x == 3) * log(t)
                   x3 <- (x == 4) * log(t)
                   cbind(scald = x1, electric = x2, flame = x3)
                 })
summary(cox_tvc)

```

```{r, warning=FALSE, error=FALSE, message=FALSE}

library(ggplot2)

coefs <- c(
  base_scald = 10.4884300, 
  base_electric = 10.8813805, 
  base_flame = 7.2799178,
  beta_scald = -3.7500636,
  beta_electric = -3.9035096,
  beta_flame = -2.3641061
)

time_seq <- seq(1, 60, by = 0.5)

HR_scald <- exp(coefs["base_scald"] + coefs["beta_scald"] * log(time_seq))
HR_electric <- exp(coefs["base_electric"] + coefs["beta_electric"] * log(time_seq))
HR_flame <- exp(coefs["base_flame"] + coefs["beta_flame"] * log(time_seq))

plot_data <- data.frame(
  Time = rep(time_seq, 3),
  HR = c(HR_scald, HR_electric, HR_flame),
  BurnType = rep(c("Scald", "Electric", "Flame"), each = length(time_seq))
)

ggplot(plot_data, aes(x = Time, y = HR, color = BurnType)) +
  geom_line(linewidth = 1.2) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
  scale_y_log10(
    limits = c(0.1, 100000),
    breaks = c(0.1, 1, 10, 100, 1000, 10000, 100000),
    labels = scales::comma
  ) +
  annotation_logticks(sides = "l") +
  labs(
    title = "Time-Varying Hazard Ratios for Burn Types",
    subtitle = "Reference: Chemical Burns (Z11=1)",
    y = "Hazard Ratio (log scale)",
    x = "Time Since Burn Injury (Days)",
    color = "Burn Type",
    caption = "Based on time-varying Cox model: HR(t) = exp(β₀ + β₁*log(t))"
  ) +
  scale_color_manual(values = c("#FF7F00", "#377EB8", "#4DAF4A")) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "bottom",
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold"),
    axis.title = element_text(face = "bold")
  ) +
  guides(color = guide_legend(title.position = "top"))
```

The Cox proportional hazards model with time-varying coefficients was utilized to examine the temporal dynamics of the hazard of Staphylococcus aureus infection following burn injuries, with burn type (Z11) as the primary covariate of interest. Burn types analyzed included scald (Z11=2), electric (Z11=3), and flame (Z11=4), each compared to the reference category of chemical burns (Z11=1). The model incorporated time-invariant covariates—treatment type (Z1), gender (Z2), and race (Z3)—to account for their fixed effects on infection risk. This approach was adopted to address potential violations of the proportional hazards assumption detected in preliminary analyses, allowing the hazard ratios (HRs) for burn types to vary logarithmically with time since injury.

The Cox model with time-varying coefficients reveals that the hazard of Staphylococcus aureus infection associated with scald, electric, and flame burns, relative to chemical burns, is markedly elevated immediately following injury but diminishes substantially over time. The baseline hazard ratios, exceeding 10,000 at t = 0, decline to values below 1 within 20 to 30 days, suggesting that the heightened risk may be confined to the early post-injury phase. This temporal pattern could reflect underlying differences in wound characteristics, healing processes, or other time-dependent factors. However, the absence of statistical significance for the time-varying coefficients (p > 0.17) and the imprecision of the estimates—evidenced by large standard errors and wide confidence intervals—limit the conclusiveness of these findings. These limitations are likely attributable to insufficient statistical power, particularly for less prevalent burn types such as electric burns.

Conversely, the fixed effects of treatment type (Z1) and race (Z3) demonstrate statistical significance and reliability. The hazard reduction of 49% associated with body cleansing (HR = 0.510, p = 0.0243) constitutes a robust finding with clear clinical relevance. Similarly, the elevated hazard among white patients (HR = 10.02, p = 0.0248) identifies a significant demographic disparity requiring further exploration, despite the uncertainty reflected in the confidence interval.

In conclusion, the time-varying Cox model offers a sophisticated framework for investigating temporal variations in infection risk across burn types, providing a potential resolution to violations of the proportional hazards assumption. Nonetheless, the primary substantive contribution of this analysis lies in the confirmation of treatment efficacy, with body cleansing emerging as a critical intervention for reducing infection risk. The suggestive but non-significant time-varying effects underscore the need for further research, ideally with larger datasets or alternative statistical approaches, to validate and refine these preliminary insights into the dynamics of burn-related infection risk.

# Bibliography

Klein and Moeschberger (1997) Survival Analysis Techniques for Censored and Truncated Data, Springer.
Ichida et al. Stat. Med. 12 (1993): 301–310
